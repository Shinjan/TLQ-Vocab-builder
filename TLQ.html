<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TLQ Vocab Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-btn {
            padding: 1rem 1.5rem;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            color: #4b5563; /* gray-600 */
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .tab-btn.active, .tab-btn:hover {
            color: #4f46e5; /* indigo-600 */
            border-bottom-color: #4f46e5;
        }
        /* Custom modal styles */
        .modal {
            animation: fadeIn 0.3s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Styles for letter boxes in Word Completion */
        .letter-box {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 2.5rem;
            height: 2.5rem;
            border: 2px solid #d1d5db; /* gray-300 */
            border-radius: 0.25rem;
            font-size: 1.5rem;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.2s ease;
            background-color: rgba(255, 255, 255, 0.2);
        }
        .letter-box.filled {
            border-color: #4f46e5;
        }
        .letter-box.correct {
            color: #22c55e; /* green-500 */
            border-color: #22c55e;
        }
        .letter-box.incorrect {
            color: #ef4444; /* red-500 */
            border-color: #ef4444;
        }

        /* --- Theme Backgrounds --- */
        .theme-pokemon #createView, .theme-pokemon #allSetsView, .theme-pokemon #learnView, .theme-pokemon #quizView,
        .theme-huntrix #createView, .theme-huntrix #allSetsView, .theme-huntrix #learnView, .theme-huntrix #quizView {
            position: relative;
            z-index: 1;
        }
        .theme-pokemon #createView::before, .theme-pokemon #allSetsView::before, .theme-pokemon #learnView::before, .theme-pokemon #quizView::before,
        .theme-huntrix #createView::before, .theme-huntrix #allSetsView::before, .theme-huntrix #learnView::before, .theme-huntrix #quizView::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-position: center;
            background-repeat: no-repeat;
            background-size: 350px;
            opacity: 0.35;
            z-index: -1;
        }
       
        /* --- Pokemon Theme Images --- */
        .theme-pokemon #createView::before { background-image: url('https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/dream-world/1.svg'); }
        .theme-pokemon #allSetsView::before { background-image: url('https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/dream-world/4.svg'); }
        .theme-pokemon #learnView::before { background-image: url('https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/dream-world/7.svg'); }
        .theme-pokemon #quizView::before { background-image: url('https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/dream-world/54.svg'); }
        
        /* --- Huntrix Theme Images (REMOVED) --- */
        .theme-huntrix #createView::before { background-image: none; }
        .theme-huntrix #allSetsView::before { background-image: none; }
        .theme-huntrix #learnView::before { background-image: none; }
        .theme-huntrix #quizView::before { background-image: none; }

        /* Semi-transparent boxes */
        .content-box {
            background-color: rgba(255, 255, 255, 0.35);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 to-purple-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-10 relative">
            <h1 class="text-4xl md:text-5xl font-bold text-indigo-600">TLQ</h1>
            <p class="text-xl text-gray-500 mt-2">Create sets, learn with flashcards, and quiz yourself.</p>
            <div class="absolute top-0 right-0 mt-2">
                <label for="themeSelector" class="font-semibold text-gray-600 mr-2">Theme:</label>
                <select id="themeSelector" class="p-2 rounded-md border bg-white/70 border-gray-300/50 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="pokemon">Pok√©mon</option>
                    <option value="huntrix">Huntrix-Daemon Hunters</option>
                    <option value="none">None</option>
                </select>
            </div>
        </header>

        <main class="max-w-5xl mx-auto bg-white/70 backdrop-blur-lg p-4 sm:p-8 rounded-lg shadow-md">
            <!-- Tab Navigation -->
            <div class="flex border-b border-gray-200/50">
                <button id="createTabBtn" class="tab-btn active">Teach</button>
                <button id="allSetsTabBtn" class="tab-btn">All Sets</button>
                <button id="learnTabBtn" class="tab-btn">Learn</button>
                <button id="quizTabBtn" class="tab-btn">Quiz</button>
            </div>

            <!-- Create Set View -->
            <div id="createView" class="py-6">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Left Column: Word Input & Definition -->
                    <div class="lg:col-span-2 space-y-6">
                        <div class="content-box p-6 rounded-lg">
                            <h2 class="text-2xl font-semibold mb-4 text-gray-800">1. Add a Word</h2>
                            <div class="space-y-4">
                                <input type="text" id="manualWordInput" class="w-full p-3 bg-white/40 border border-gray-300/50 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Enter the word...">
                                <textarea id="manualMeaningInput" rows="3" class="w-full p-3 bg-white/40 border border-gray-300/50 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Enter its meaning..."></textarea>
                                <textarea id="manualSentenceInput" rows="2" class="w-full p-3 bg-white/40 border border-gray-300/50 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Enter an example sentence..."></textarea>
                                <button id="addWordBtn" class="bg-blue-600/80 text-white font-bold py-3 px-6 rounded-md hover:bg-blue-700 transition-colors duration-300">Add to Current Set</button>
                            </div>
                        </div>
                    </div>
                    <!-- Right Column: Set Management -->
                    <div class="lg:col-span-1 space-y-6">
                        <div class="content-box p-6 rounded-lg h-full flex flex-col">
                            <h2 class="text-2xl font-semibold mb-4 text-gray-800">2. Build Your Set</h2>
                            <div id="currentSetContainer" class="flex-grow">
                                <p id="currentSetPlaceholder" class="text-gray-500 italic">Words you add will appear here.</p>
                                <ul id="currentSetList" class="space-y-2"></ul>
                            </div>
                            <div class="mt-6">
                                <input type="text" id="setNameInput" class="w-full p-3 bg-white/40 border border-gray-300/50 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Name your new set...">
                                <button id="addSetBtn" class="w-full bg-green-600/80 text-white font-bold py-3 px-6 rounded-md hover:bg-green-700 transition-colors duration-300 mt-3">Add Set</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- All Sets View -->
            <div id="allSetsView" class="py-6 hidden">
                 <div class="content-box p-6 rounded-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">Manage My Sets</h2>
                    <div class="flex justify-end gap-2 mb-4">
                        <button id="importBtn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-md hover:bg-gray-600">Import Sets</button>
                        <button id="exportBtn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-md hover:bg-gray-600">Export Sets</button>
                    </div>
                    <div id="allSetsListContainer">
                        <p id="allSetsPlaceholder" class="text-gray-500 italic">Your saved sets will appear here.</p>
                        <ul id="allSetsList" class="space-y-3"></ul>
                    </div>
                 </div>
            </div>

            <!-- Learn Mode View -->
            <div id="learnView" class="py-6 hidden">
                <div class="content-box p-6 rounded-lg text-center">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">Start a Learning Session</h2>
                    <p class="text-gray-600 mb-6">Select one or more sets to include in your flashcard session.</p>
                    <div id="setSelectionContainer" class="max-w-md mx-auto">
                        <p id="learnModePlaceholder" class="text-gray-500 italic">Create a set in 'Teach' mode first!</p>
                        <ul id="learnSetSelectionList" class="text-left space-y-2 mb-6"></ul>
                        <button id="startLearningBtn" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-md hover:bg-indigo-700 transition-colors duration-300 hidden">Start Learning</button>
                    </div>
                </div>
            </div>

            <!-- Quiz Mode View -->
            <div id="quizView" class="py-6 hidden">
                 <div class="content-box p-6 rounded-lg text-center">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800">Start a Quiz</h2>
                    <p class="text-gray-600 mb-6">1. Select sets to quiz yourself on.</p>
                    <div id="quizSetSelectionContainer" class="max-w-md mx-auto mb-8">
                        <p id="quizModePlaceholder" class="text-gray-500 italic">Create a set in 'Teach' mode first!</p>
                        <ul id="quizSetSelectionList" class="text-left space-y-2"></ul>
                    </div>
                    <p class="text-gray-600 mb-6">2. Choose a quiz type.</p>
                    <div class="flex justify-center gap-4">
                        <button id="startWordCompletionBtn" class="bg-teal-600 text-white font-bold py-3 px-8 rounded-md hover:bg-teal-700 transition-colors duration-300">Word Completion</button>
                        <button id="startMeaningMatchingBtn" class="bg-purple-600 text-white font-bold py-3 px-8 rounded-md hover:bg-purple-700 transition-colors duration-300">Meaning Matching</button>
                    </div>
                 </div>
            </div>

        </main>
    </div>

    <!-- General Modal -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="modal bg-white p-8 rounded-lg shadow-2xl max-w-sm w-full text-center">
            <h3 id="modalTitle" class="text-2xl font-bold mb-4">Notification</h3>
            <p id="modalMessage" class="text-gray-600 mb-6">This is a message.</p>
            <div id="modalActions">
                <button id="modalCloseBtn" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-md hover:bg-gray-400">Close</button>
            </div>
        </div>
    </div>

    <!-- Learning Session Overlay -->
    <div id="learningSession" class="hidden fixed inset-0 bg-gradient-to-br from-indigo-400 to-purple-500 p-8 flex flex-col items-center justify-center z-40">
        <div id="flashcard" class="relative bg-white/30 backdrop-blur-xl p-8 rounded-lg shadow-xl w-full max-w-2xl text-center text-white min-h-[300px] flex flex-col justify-center items-center">
             <div id="flashcardPokemon" class="absolute inset-0 z-0 opacity-20 bg-center bg-contain bg-no-repeat"></div>
            <div class="relative z-10">
                <h2 id="flashcardWord" class="text-5xl font-bold mb-4">Word</h2>
                <p id="flashcardMeaning" class="text-xl mb-4">Meaning</p>
                <p id="flashcardSentence" class="text-lg italic">Sentence</p>
            </div>
        </div>
        <button id="nextWordBtn" class="mt-8 bg-white/80 text-indigo-600 font-bold py-3 px-8 rounded-md hover:bg-white transition-colors duration-300">Next Word</button>
        <button id="closeLearningBtn" class="absolute top-8 right-8 text-white text-4xl font-bold">&times;</button>
    </div>

    <!-- Quiz Session Overlay -->
    <div id="quizSession" class="hidden fixed inset-0 bg-gray-900/90 backdrop-blur-sm p-4 flex flex-col items-center justify-center z-40">
        <div id="quizContainer" class="relative w-full max-w-4xl text-white text-center">
             <div id="quizPokemon" class="absolute inset-0 z-0 opacity-10 bg-center bg-contain bg-no-repeat"></div>
        </div>
        <button id="closeQuizBtn" class="absolute top-4 right-8 text-white text-5xl font-bold">&times;</button>
    </div>
    
    <!-- Hidden file input for imports -->
    <input type="file" id="importFileInput" class="hidden" accept=".json">

    <script>
        // --- DOM Elements ---
        const createTabBtn = document.getElementById('createTabBtn');
        const allSetsTabBtn = document.getElementById('allSetsTabBtn');
        const learnTabBtn = document.getElementById('learnTabBtn');
        const quizTabBtn = document.getElementById('quizTabBtn');

        const createView = document.getElementById('createView');
        const allSetsView = document.getElementById('allSetsView');
        const learnView = document.getElementById('learnView');
        const quizView = document.getElementById('quizView');

        const manualWordInput = document.getElementById('manualWordInput');
        const manualMeaningInput = document.getElementById('manualMeaningInput');
        const manualSentenceInput = document.getElementById('manualSentenceInput');
        const addWordBtn = document.getElementById('addWordBtn');
        
        const currentSetList = document.getElementById('currentSetList');
        const currentSetPlaceholder = document.getElementById('currentSetPlaceholder');
        const setNameInput = document.getElementById('setNameInput');
        const addSetBtn = document.getElementById('addSetBtn');

        const allSetsList = document.getElementById('allSetsList');
        const allSetsPlaceholder = document.getElementById('allSetsPlaceholder');
        const importBtn = document.getElementById('importBtn');
        const exportBtn = document.getElementById('exportBtn');
        const importFileInput = document.getElementById('importFileInput');
        
        const learnSetSelectionList = document.getElementById('learnSetSelectionList');
        const learnModePlaceholder = document.getElementById('learnModePlaceholder');
        const startLearningBtn = document.getElementById('startLearningBtn');

        const quizSetSelectionList = document.getElementById('quizSetSelectionList');
        const quizModePlaceholder = document.getElementById('quizModePlaceholder');
        const startWordCompletionBtn = document.getElementById('startWordCompletionBtn');
        const startMeaningMatchingBtn = document.getElementById('startMeaningMatchingBtn');

        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalActions = document.getElementById('modalActions');
        const modalCloseBtn = document.getElementById('modalCloseBtn');

        const learningSession = document.getElementById('learningSession');
        const flashcardWord = document.getElementById('flashcardWord');
        const flashcardMeaning = document.getElementById('flashcardMeaning');
        const flashcardSentence = document.getElementById('flashcardSentence');
        const nextWordBtn = document.getElementById('nextWordBtn');
        const closeLearningBtn = document.getElementById('closeLearningBtn');
        const flashcardPokemon = document.getElementById('flashcardPokemon');
        
        const quizSession = document.getElementById('quizSession');
        const quizContainer = document.getElementById('quizContainer');
        const closeQuizBtn = document.getElementById('closeQuizBtn');
        const quizPokemon = document.getElementById('quizPokemon');
        const themeSelector = document.getElementById('themeSelector');

        // --- Game State ---
        let allSets = {};
        let currentSet = [];
        let studyPool = [];
        let currentWordIndex = 0;
        let currentTheme = 'pokemon';
        
        // Quiz state
        let quizPool = [];
        let currentQuizWord = {};
        let currentMatchingBatch = [];
        let selectedWordElement = null;
        let selectedMeaningElement = null;
        let connections = [];
        let correctMatches = 0;

        // --- Theme Assets ---
        const huntrixImageUrls = [
            // User can supply their own image URLs here
        ];

        // --- Utility Functions ---
        function showModal(title, message, actions = null) {
            modalTitle.textContent = title;
            modalMessage.innerHTML = message; // Use innerHTML to allow for HTML content
            modalActions.innerHTML = ''; // Clear previous actions

            if (actions) {
                modalActions.appendChild(actions);
            } else {
                const closeButton = document.createElement('button');
                closeButton.textContent = 'Close';
                closeButton.className = 'bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-md hover:bg-gray-400';
                closeButton.onclick = hideModal;
                modalActions.appendChild(closeButton);
            }
            modal.classList.remove('hidden');
        }

        function hideModal() {
            modal.classList.add('hidden');
        }
        
        function getThemedImageUrl() {
            if (currentTheme === 'pokemon') {
                const pokemonId = Math.floor(Math.random() * 151) + 1;
                return `url('https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/dream-world/${pokemonId}.svg')`;
            }
            if (currentTheme === 'huntrix' && huntrixImageUrls.length > 0) {
                const imageUrl = huntrixImageUrls[Math.floor(Math.random() * huntrixImageUrls.length)];
                return `url('${imageUrl}')`;
            }
            return 'none';
        }

        // --- Data Persistence ---
        function loadSets() {
            try {
                const savedSets = localStorage.getItem('tlqSets');
                if (savedSets) {
                    allSets = JSON.parse(savedSets);
                } else {
                    allSets = {};
                }
            } catch (e) {
                console.error("Could not load sets from localStorage:", e);
                allSets = {};
            }
            updateAllViews();
        }

        function saveSets() {
            localStorage.setItem('tlqSets', JSON.stringify(allSets));
        }

        // --- Render Functions ---
        function renderCurrentSet() {
            currentSetList.innerHTML = '';
            if (currentSet.length === 0) {
                currentSetPlaceholder.classList.remove('hidden');
            } else {
                currentSetPlaceholder.classList.add('hidden');
                currentSet.forEach((wordData, index) => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-white/30 p-2 rounded';
                    li.innerHTML = `
                        <span class="capitalize font-medium">${wordData.word}</span>
                        <button onclick="removeFromCurrentSet(${index})" class="text-red-500 hover:text-red-700 font-bold text-lg"> &times; </button>
                    `;
                    currentSetList.appendChild(li);
                });
            }
        }

        function renderAllSets() {
            allSetsList.innerHTML = '';
            const setNames = Object.keys(allSets);
            if (setNames.length === 0) {
                allSetsPlaceholder.classList.remove('hidden');
            } else {
                allSetsPlaceholder.classList.add('hidden');
                setNames.forEach(name => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-white/30 p-3 rounded';
                    li.innerHTML = `
                        <span class="font-semibold text-lg">${name} (${allSets[name].length} words)</span>
                        <div class="flex items-center gap-3">
                            <button onclick="viewSet('${name}')" class="bg-blue-500/80 text-white font-bold py-1 px-3 rounded-md text-sm hover:bg-blue-600">View</button>
                            <button onclick="deleteSet('${name}')" class="bg-red-500/80 text-white font-bold py-1 px-3 rounded-md text-sm hover:bg-red-600">Delete</button>
                        </div>
                    `;
                    allSetsList.appendChild(li);
                });
            }
        }
        
        function renderSetSelectionList(listElement, placeholderElement, startBtnElement) {
            listElement.innerHTML = '';
            const setNames = Object.keys(allSets);
            if (setNames.length === 0) {
                placeholderElement.classList.remove('hidden');
                if(startBtnElement) startBtnElement.classList.add('hidden');
            } else {
                placeholderElement.classList.add('hidden');
                 if(startBtnElement) startBtnElement.classList.remove('hidden');
                setNames.forEach(name => {
                    const li = document.createElement('li');
                    li.className = 'p-3 bg-white/30 rounded';
                    li.innerHTML = `
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" data-set-name="${name}" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <span class="font-semibold">${name}</span>
                        </label>
                    `;
                    listElement.appendChild(li);
                });
            }
        }

        // --- Teach Mode Functions ---
        function addWordToCurrentSet() {
            const word = manualWordInput.value.trim();
            const meaning = manualMeaningInput.value.trim();
            const sentence = manualSentenceInput.value.trim();

            if (!word || !meaning) {
                showModal('Error', 'Please enter both a word and its meaning.');
                return;
            }

            currentSet.push({ word, meaning, sentence });
            manualWordInput.value = '';
            manualMeaningInput.value = '';
            manualSentenceInput.value = '';
            renderCurrentSet();
            manualWordInput.focus();
        }
        
        window.removeFromCurrentSet = (index) => {
            currentSet.splice(index, 1);
            renderCurrentSet();
        }

        function saveCurrentSet() {
            const name = setNameInput.value.trim();
            if (!name) {
                showModal('Error', 'Please provide a name for your set.');
                return;
            }
            if (currentSet.length === 0) {
                showModal('Error', 'Please add at least one word to the set.');
                return;
            }
            if (allSets[name]) {
                showModal('Error', `A set named "${name}" already exists.`);
                return;
            }

            allSets[name] = [...currentSet];
            saveSets();
            currentSet = [];
            setNameInput.value = '';
            renderCurrentSet();
            
            const successModalActions = document.createElement('div');
            const okButton = document.createElement('button');
            okButton.textContent = 'OK';
            okButton.className = 'bg-green-500 text-white font-bold py-2 px-6 rounded-md hover:bg-green-600';
            okButton.onclick = () => {
                hideModal();
                switchTab('allSets');
            };
            successModalActions.appendChild(okButton);
            showModal('Success!', `Set "${name}" has been saved.`, successModalActions);
        }

        window.viewSet = (name) => {
            const set = allSets[name];
            if (!set) return;

            let content = '<ul class="text-left space-y-4 max-h-60 overflow-y-auto pr-2">';
            set.forEach(wordData => {
                const sentenceHTML = (wordData.sentence && wordData.sentence.trim() !== '')
                    ? `<div class="italic text-gray-600 pl-4">"${wordData.sentence}"</div>`
                    : '';
                
                content += `
                    <li class="border-b pb-2">
                        <div><strong class="capitalize text-indigo-700">${wordData.word}:</strong> ${wordData.meaning}</div>
                        ${sentenceHTML}
                    </li>`;
            });
            content += '</ul>';
            showModal(`Words in "${name}"`, content);
        }

        window.deleteSet = (name) => {
            const confirmationActions = document.createElement('div');
            confirmationActions.className = 'flex justify-center gap-4';

            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = 'Yes, Delete';
            confirmBtn.className = 'bg-red-500 text-white font-bold py-2 px-4 rounded-md hover:bg-red-600';
            confirmBtn.onclick = () => {
                delete allSets[name];
                saveSets();
                updateAllViews();
                hideModal();
            };

            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Cancel';
            cancelBtn.className = 'bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md hover:bg-gray-400';
            cancelBtn.onclick = hideModal;
            
            confirmationActions.appendChild(cancelBtn);
            confirmationActions.appendChild(confirmBtn);

            showModal('Confirm Deletion', `Are you sure you want to delete the set "${name}"?`, confirmationActions);
        }

        // --- Import/Export Functions ---
        function exportSets() {
            if (Object.keys(allSets).length === 0) {
                showModal('Nothing to Export', 'You have not created any sets to export.');
                return;
            }
            const dataStr = JSON.stringify(allSets, null, 2);
            const dataBlob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.download = 'tlq_sets.json';
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
        }

        function importSets() {
            importFileInput.click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedSets = JSON.parse(e.target.result);
                    // Simple validation
                    if (typeof importedSets !== 'object' || Array.isArray(importedSets)) {
                        throw new Error('Invalid file format.');
                    }
                    // Merge with existing sets
                    Object.assign(allSets, importedSets);
                    saveSets();
                    updateAllViews();
                    showModal('Success', 'Sets have been successfully imported.');
                } catch (error) {
                    showModal('Import Error', 'Could not import sets. The file might be corrupted or in the wrong format.');
                } finally {
                    // Reset the file input to allow re-importing the same file
                    event.target.value = null;
                }
            };
            reader.readAsText(file);
        }

        // --- Learn Mode Functions ---
        function startLearningSession() {
            const selectedSets = Array.from(learnSetSelectionList.querySelectorAll('input:checked'))
                                      .map(input => input.dataset.setName);
            
            if (selectedSets.length === 0) {
                showModal('Select Sets', 'Please select at least one set to start learning.');
                return;
            }

            studyPool = [];
            selectedSets.forEach(setName => {
                studyPool.push(...allSets[setName]);
            });

            if (studyPool.length === 0) {
                 showModal('Empty Sets', 'The selected sets have no words. Please add words in the Teach mode.');
                return;
            }

            studyPool.sort(() => Math.random() - 0.5);
            currentWordIndex = 0;
            showNextWord();
            learningSession.classList.remove('hidden');
        }

        function showNextWord() {
            if (studyPool.length === 0) return;
            
            const wordData = studyPool[currentWordIndex];
            flashcardWord.textContent = wordData.word;
            flashcardMeaning.textContent = wordData.meaning;
            flashcardSentence.textContent = wordData.sentence || '';
            
            flashcardPokemon.style.backgroundImage = getThemedImageUrl();
            
            currentWordIndex = (currentWordIndex + 1) % studyPool.length;
        }

        function closeLearningSession() {
            learningSession.classList.add('hidden');
        }
        
        // --- Quiz Mode Functions ---
        function getSelectedQuizSets() {
            const selectedSets = Array.from(quizSetSelectionList.querySelectorAll('input:checked'))
                                      .map(input => input.dataset.setName);

            if (selectedSets.length === 0) {
                showModal('Select Sets', 'Please select at least one set for the quiz.');
                return null;
            }

            let pool = [];
            selectedSets.forEach(setName => {
                pool.push(...allSets[setName]);
            });

            if (pool.length === 0) {
                showModal('Empty Sets', 'The selected sets have no words. Please add words in the Teach mode.');
                return null;
            }
            
            return pool.sort(() => Math.random() - 0.5);
        }

        // Word Completion Logic
        function startWordCompletionQuiz() {
            const pool = getSelectedQuizSets();
            if (!pool) return;
            quizPool = [...pool]; // Create a copy
            
            quizSession.classList.remove('hidden');
            nextWordCompletion();
        }

        function nextWordCompletion() {
            if (quizPool.length === 0) {
                 const newPool = getSelectedQuizSets(); 
                 if (!newPool || newPool.length === 0) {
                     closeQuizSession();
                     showModal('Quiz Complete!', 'Not enough words to form a new challenge. Great job!');
                     return;
                 }
                 quizPool = [...newPool];
            }

            const wordIndex = Math.floor(Math.random() * quizPool.length);
            currentQuizWord = quizPool.splice(wordIndex, 1)[0];


            const { word, meaning } = currentQuizWord;

            let missingIndices = [];
            const wordArr = word.split('');
            const numMissing = Math.max(1, Math.floor(word.length / 4));
            while (missingIndices.length < numMissing && missingIndices.length < word.length) {
                const randIndex = Math.floor(Math.random() * word.length);
                if (!missingIndices.includes(randIndex) && wordArr[randIndex] !== ' ') {
                    missingIndices.push(randIndex);
                }
            }
            missingIndices.sort((a,b) => a - b);
            
            let html = `<div class="relative z-10 w-full">
                <p class="text-xl mb-4">${meaning}</p>
                <div id="wordCompletionBox" class="flex justify-center items-center gap-2 mb-4">`;

            let blankCounter = 0;
            for(let i=0; i < wordArr.length; i++) {
                if (missingIndices.includes(i)) {
                    html += `<input type="text" maxlength="1" data-index="${blankCounter++}" data-char="${wordArr[i]}" class="letter-box bg-transparent text-white w-12 h-12 text-2xl text-center">`;
                } else {
                    html += `<span class="letter-box bg-white/10 border-white/20">${wordArr[i]}</span>`;
                }
            }
            html += `</div><p id="completionMessage" class="h-6 text-lg">&nbsp;</p></div>`;
            quizContainer.innerHTML = html;
            
            quizPokemon.style.backgroundImage = getThemedImageUrl();

            const inputs = Array.from(quizContainer.querySelectorAll('input'));
            inputs.forEach((input, idx) => {
                input.addEventListener('input', (e) => handleCompletionInput(e, inputs));
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !input.value && idx > 0) {
                        inputs[idx-1].focus();
                    }
                });
            });
            if(inputs.length > 0) inputs[0].focus();
        }

        function handleCompletionInput(event, inputs) {
            const input = event.target;
            const typedChar = input.value.toLowerCase();
            const correctChar = input.dataset.char.toLowerCase();
            const messageEl = document.getElementById('completionMessage');

            input.value = typedChar; 
            messageEl.textContent = '\u00A0';

            if (typedChar === correctChar) {
                input.classList.remove('incorrect');
                input.classList.add('correct');
                const nextInput = inputs[parseInt(input.dataset.index) + 1];
                if (nextInput) {
                    nextInput.focus();
                } else {
                    const allCorrect = inputs.every(inp => inp.value.toLowerCase() === inp.dataset.char.toLowerCase());
                    if (allCorrect) {
                        messageEl.textContent = 'Correct!';
                        messageEl.classList.remove('text-red-400');
                        messageEl.classList.add('text-green-400');
                        setTimeout(() => {
                            nextWordCompletion();
                        }, 1200);
                    }
                }
            } else {
                input.classList.add('incorrect');
                messageEl.textContent = 'Try again!';
                messageEl.classList.remove('text-green-400');
                messageEl.classList.add('text-red-400');
                setTimeout(() => {
                    input.value = '';
                    input.classList.remove('incorrect');
                    if (messageEl.textContent === 'Try again!') {
                        messageEl.textContent = '\u00A0';
                    }
                }, 2000);
            }
        }


        // Meaning Matching Logic
        function startMeaningMatchingQuiz() {
            const pool = getSelectedQuizSets();
            if (!pool || pool.length < 2) {
                if(pool) showModal('Not Enough Words', 'You need at least two words in the selected sets to start this quiz.');
                return;
            }
            quizPool = [...pool]; // Store the full pool
            quizSession.classList.remove('hidden');
            nextMatchingBatch();
        }
        
        function nextMatchingBatch() {
            if (quizPool.length < 2) {
                const newPool = getSelectedQuizSets(); // Get a fresh, full pool
                if (!newPool || newPool.length < 2) {
                    closeQuizSession();
                    showModal('Quiz Complete!', 'Not enough words to form a new match. Great job!');
                    return;
                }
                 quizPool = [...newPool];
            }
            
            const batchSize = Math.min(quizPool.length, 5);
            
            currentMatchingBatch = quizPool.splice(0, batchSize);
            
            let words = currentMatchingBatch.map(item => item);
            let meanings = [...currentMatchingBatch];

            
            let isPerfectShuffle = false;
            let shuffleCount = 0;
            while (!isPerfectShuffle && shuffleCount < 10) { 
                meanings.sort(() => Math.random() - 0.5);
                isPerfectShuffle = true;
                for (let i = 0; i < words.length; i++) {
                    if (words[i].word === meanings[i].word) {
                        isPerfectShuffle = false;
                        break;
                    }
                }
                shuffleCount++;
            }

            let html = `<div class="relative z-10 w-full flex justify-center gap-8 md:gap-16">
                <div id="words-column" class="flex flex-col gap-4">`;
            words.forEach((item) => {
                html += `<div data-word="${item.word}" class="match-item bg-indigo-500/50 p-4 rounded-lg cursor-pointer transition-all duration-200">${item.word}</div>`;
            });
            html += `</div>
                <svg id="connector-svg" class="absolute top-0 left-0 w-full h-full" style="pointer-events:none; z-index: -1;"></svg>
                <div id="meanings-column" class="flex flex-col gap-4">`;
            meanings.forEach((item) => {
                html += `<div data-word="${item.word}" class="match-item bg-purple-500/50 p-4 rounded-lg cursor-pointer transition-all duration-200">${item.meaning}</div>`;
            });
            html += `</div></div>`;
            quizContainer.innerHTML = html;
            
            quizPokemon.style.backgroundImage = getThemedImageUrl();

            document.querySelectorAll('.match-item').forEach(item => {
                item.addEventListener('click', handleMatchSelection);
            });

            connections = [];
            correctMatches = 0;
        }

        function handleMatchSelection(e) {
            const target = e.currentTarget;
            const column = target.parentElement.id;

            if (column === 'words-column') {
                if (selectedWordElement) selectedWordElement.classList.remove('ring-4', 'ring-yellow-300');
                selectedWordElement = target;
                selectedWordElement.classList.add('ring-4', 'ring-yellow-300');
            } else if (column === 'meanings-column') {
                if (selectedMeaningElement) selectedMeaningElement.classList.remove('ring-4', 'ring-yellow-300');
                selectedMeaningElement = target;
                selectedMeaningElement.classList.add('ring-4', 'ring-yellow-300');
            }

            if (selectedWordElement && selectedMeaningElement) {
                checkMatch();
            }
        }

        function checkMatch() {
            const word = selectedWordElement.dataset.word;
            const meaningWord = selectedMeaningElement.dataset.word;
            const isCorrect = word === meaningWord;
            
            drawConnection(selectedWordElement, selectedMeaningElement, isCorrect);

            if (isCorrect) {
                selectedWordElement.style.pointerEvents = 'none';
                selectedMeaningElement.style.pointerEvents = 'none';
                selectedWordElement.classList.replace('bg-indigo-500/50', 'bg-green-500/70');
                selectedMeaningElement.classList.replace('bg-purple-500/50', 'bg-green-500/70');
                correctMatches++;
            }

            selectedWordElement.classList.remove('ring-4', 'ring-yellow-300');
            selectedMeaningElement.classList.remove('ring-4', 'ring-yellow-300');
            selectedWordElement = null;
            selectedMeaningElement = null;

            if (correctMatches === currentMatchingBatch.length) {
                setTimeout(nextMatchingBatch, 1500);
            }
        }

        function drawConnection(el1, el2, isCorrect) {
            const svg = document.getElementById('connector-svg');
            if (!svg) return;
            const containerRect = quizContainer.getBoundingClientRect();

            const rect1 = el1.getBoundingClientRect();
            const rect2 = el2.getBoundingClientRect();

            const x1 = rect1.right - containerRect.left;
            const y1 = rect1.top + rect1.height / 2 - containerRect.top;
            const x2 = rect2.left - containerRect.left;
            const y2 = rect2.top + rect2.height / 2 - containerRect.top;

            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const d = `M ${x1} ${y1} C ${x1 + 60} ${y1}, ${x2 - 60} ${y2}, ${x2} ${y2}`;
            path.setAttribute('d', d);
            path.setAttribute('stroke-width', '4');
            path.setAttribute('fill', 'none');
            path.style.transition = 'stroke 0.3s';
            
            const color = isCorrect ? '#22c55e' : '#ef4444';
            path.setAttribute('stroke', color);
            svg.appendChild(path);

            if (!isCorrect) {
                setTimeout(() => {
                    if (svg.contains(path)) svg.removeChild(path);
                }, 800);
            }
        }

        function closeQuizSession() {
            quizSession.classList.add('hidden');
            quizContainer.innerHTML = '';
        }

        // --- Tab Switching ---
        function switchTab(tab) {
            createView.classList.add('hidden');
            allSetsView.classList.add('hidden');
            learnView.classList.add('hidden');
            quizView.classList.add('hidden');

            createTabBtn.classList.remove('active');
            allSetsTabBtn.classList.remove('active');
            learnTabBtn.classList.remove('active');
            quizTabBtn.classList.remove('active');

            if (tab === 'create') {
                createView.classList.remove('hidden');
                createTabBtn.classList.add('active');
            } else if (tab === 'allSets') {
                allSetsView.classList.remove('hidden');
                allSetsTabBtn.classList.add('active');
                updateAllViews();
            } else if (tab === 'learn') {
                learnView.classList.remove('hidden');
                learnTabBtn.classList.add('active');
                updateAllViews();
            } else if (tab === 'quiz') {
                quizView.classList.remove('hidden');
                quizTabBtn.classList.add('active');
                updateAllViews();
            }
        }
        
        function updateAllViews() {
            renderAllSets();
            renderSetSelectionList(learnSetSelectionList, learnModePlaceholder, startLearningBtn);
            renderSetSelectionList(quizSetSelectionList, quizModePlaceholder, null);
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            createTabBtn.addEventListener('click', () => switchTab('create'));
            allSetsTabBtn.addEventListener('click', () => switchTab('allSets'));
            learnTabBtn.addEventListener('click', () => switchTab('learn'));
            quizTabBtn.addEventListener('click', () => switchTab('quiz'));

            addWordBtn.addEventListener('click', addWordToCurrentSet);
            addSetBtn.addEventListener('click', saveCurrentSet);
            modalCloseBtn.addEventListener('click', hideModal);

            exportBtn.addEventListener('click', exportSets);
            importBtn.addEventListener('click', importSets);
            importFileInput.addEventListener('change', handleFileImport);

            startLearningBtn.addEventListener('click', startLearningSession);
            nextWordBtn.addEventListener('click', showNextWord);
            closeLearningBtn.addEventListener('click', closeLearningSession);

            startWordCompletionBtn.addEventListener('click', startWordCompletionQuiz);
            startMeaningMatchingBtn.addEventListener('click', startMeaningMatchingQuiz);
            closeQuizBtn.addEventListener('click', closeQuizSession);

            themeSelector.addEventListener('change', handleThemeChange);
        }

        // --- Theme Management ---
        function applyTheme(theme) {
            document.body.classList.remove('theme-pokemon', 'theme-huntrix');
            if (theme === 'pokemon') {
                document.body.classList.add('theme-pokemon');
            } else if (theme === 'huntrix') {
                document.body.classList.add('theme-huntrix');
            }
        }

        function handleThemeChange() {
            currentTheme = themeSelector.value;
            localStorage.setItem('tlqTheme', currentTheme);
            applyTheme(currentTheme);
        }

        // --- Initial Load ---
        function init() {
            const savedTheme = localStorage.getItem('tlqTheme') || 'pokemon';
            currentTheme = savedTheme;
            themeSelector.value = currentTheme;
            applyTheme(currentTheme);
            loadSets();
            setupEventListeners();
        }

        init();
    </script>
</body>
</html>

